<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Drawify (Realtime drawing)</title>
    <style>
      #canvas {
        background-color: aliceblue;
      }

      * {
        -khtml-user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        user-select: none;    
      }

      .clearBtn, .beepBtn, .users {
        margin-right: 20px; 
        position: absolute;  
        right: 0;
      }

      .clearBtn {
        margin-top: 10px;            
      }

      .beepBtn {
        margin-top: 60px;
      }

      .users {
        bottom: 0; 
        color: darkgray;
      }
    </style>
  </head>
  <body> 
    <audio id="audio" src="/beep.mp3" preload="none"></audio>
    <canvas id="canvas"></canvas>
    <button class="clearBtn" onclick="return clearCanvas()">Clear the canvas!</button>
    <button class="beepBtn" onclick="return sendBeep()">Beep AFK!</button>
    <h1 id="users" class="users"></h1>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var sound = document.getElementById("audio");
      var users = document.getElementById("users");
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");
      var afk = false;
      var socket = io();

      canvas.width  = window.innerWidth-20;
      canvas.height = window.innerHeight-20;

      function toHex(str) {
        var hash = 0;
        for (var i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        var c = (hash & 0x00FFFFFF).toString(16);
        return "00000".substring(0, 6 - c.length) + c;
      }
      
      function drawPoint(x, y, id) {
        ctx.fillStyle = "#"+toHex(id);
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI*2);
        ctx.fill();
      }

      function clearCanvas() {
        if (confirm("Clear your canvas?")) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }
      
      function sendPoint(x, y) {
        socket.emit('point', { x: x, y: y });
        drawPoint(x, y, socket.id);
      }

      function sendBeep() {
        socket.emit('alert');
        sound.play();
      }

      canvas.addEventListener('mousemove', (event) => {
        var x = event.pageX - canvas.offsetLeft;
        var y = event.pageY - canvas.offsetTop;
        if (event.buttons) {
          sendPoint(x,y);
        }
      });

      canvas.addEventListener('mousedown', (event) => { 
        var x = event.pageX - canvas.offsetLeft;
        var y = event.pageY - canvas.offsetTop;
        sendPoint(x, y);
      });

      canvas.addEventListener("touchmove", (event) => {
        var touch = event.targetTouches[0];
        var x = touch.pageX - canvas.offsetLeft;
        var y = touch.pageY - canvas.offsetTop;
        sendPoint(x, y)
      });

      socket.on('point', (event) => {   
        drawPoint(event.x, event.y, event.id);
      });

      socket.on('beep', () => {
          if (afk) sound.play();
      });

      socket.on('users', (data) => {
        users.innerHTML = `Online ${data.count}`;
      });

      window.addEventListener('resize', () => {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        canvas.width = window.innerWidth-20;
        canvas.height = window.innerHeight-20;
        ctx.putImageData(imageData, 0, 0);
      });

      window.addEventListener('blur', () => {
        afk = true;
      });

      window.addEventListener('focus', () => {
        afk = false;
      });
    </script>
  </body>
</html>
